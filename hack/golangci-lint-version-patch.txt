// Package goutil provides utility functions for golangci-lint.
//
// This file has been patched to bypass the Go version check in CheckGoVersion.
// The original implementation prevents golangci-lint built with Go 1.24 from
// linting projects that declare a higher Go version (e.g., Go 1.25).
//
// WARNING: This patch allows the linter to run, but note that golangci-lint
// built with Go 1.24 cannot fully analyze Go 1.25+ syntax. When linting Go 1.25+
// projects, temporarily downgrade the `go` directive in go.mod to 1.24 before
// running lint, then restore it afterwards.

package goutil

import (
	"fmt"
	"regexp"
	"runtime"
	"strings"
)

func CheckGoVersion(goVersion string) error {
	// Skip version check to allow newer Go versions
	return nil
}

// TrimGoVersion Trims the Go version to keep only M.m.
// Since Go 1.21 the version inside the go.mod can be a patched version (ex: 1.21.0).
// The version can also include information which we want to remove (ex: 1.21alpha1)
// https://go.dev/doc/toolchain#versions
// This a problem with staticcheck and gocritic.
func TrimGoVersion(v string) string {
	if v == "" {
		return ""
	}

	exp := regexp.MustCompile(`(\d\.\d+)(?:\.\d+|[a-z]+\d)`)

	if exp.MatchString(v) {
		return exp.FindStringSubmatch(v)[1]
	}

	return v
}

func CleanRuntimeVersion() (string, error) {
	return cleanRuntimeVersion(runtime.Version())
}

func cleanRuntimeVersion(rv string) (string, error) {
	for part := range strings.FieldsSeq(rv) {
		// Allow to handle:
		// - GOEXPERIMENT -> "go1.23.0 X:boringcrypto"
		// - devel -> "devel go1.24-e705a2d Wed Aug 7 01:16:42 2024 +0000 linux/amd64"
		if strings.HasPrefix(part, "go1.") {
			return part, nil
		}
	}

	return "", fmt.Errorf("invalid Go runtime version: %s", rv)
}
